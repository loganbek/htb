<!--
 // Platform: Academy
// URL: https://academy.hackthebox.com/module/227/section/2499
// Platform Version: V1
// Module ID: 227
// Module Name: Introduction to Malware Analysis
// Module Difficulty: Hard
// Section ID: 2499
// Section Title: Code Analysis
// Page Title: Introduction to Malware Analysis
// Page Number: 06
-->

# Code Analysis

**Module Name:** Introduction to Malware Analysis **Page Number:** 06

#### INTRODUCTION TO MALWARE ANALYSIS

# Code Analysis

## Reverse Engineering & Code Analysis

![https://academy.hackthebox.com/storage/modules/227/disassembly.png](https://academy.hackthebox.com/storage/modules/227/disassembly.png)

``` shell-session
[!bash!]$ xfreerdp /u:htb-student /p:'HTB_@cademy_stdnt!' /v:[Target IP] /dynamic-resolution
```

## Code Analysis Example: shell.exe

### Importing a Malware Sample into the Disassembler - IDA

![https://academy.hackthebox.com/storage/modules/227/ida_intro.png](https://academy.hackthebox.com/storage/modules/227/ida_intro.png)

![https://academy.hackthebox.com/storage/modules/227/ida_intro_processor.png](https://academy.hackthebox.com/storage/modules/227/ida_intro_processor.png)

![https://academy.hackthebox.com/storage/modules/227/ida_intro_views.png](https://academy.hackthebox.com/storage/modules/227/ida_intro_views.png)

### Text and Graph Views

![https://academy.hackthebox.com/storage/modules/227/ida_graph_view.png](https://academy.hackthebox.com/storage/modules/227/ida_graph_view.png)

``` ida
text:00000000004014F0 ; =============== S U B R O U T I N E =======================================
text:00000000004014F0
text:00000000004014F0
text:00000000004014F0                 public start
text:00000000004014F0 start           proc near               ; DATA XREF: .pdata:000000000040603C↓o
text:00000000004014F0
text:00000000004014F0 ; FUNCTION CHUNK AT 			.text:00000000004022A0 SIZE 000001B0 BYTES
text:00000000004014F0
text:00000000004014F0 ; __unwind { // __C_specific_handler
text:00000000004014F0                 sub     rsp, 28h
text:00000000004014F4
text:00000000004014F4 loc_4014F4:                             ; DATA XREF: .xdata:0000000000407058↓o
text:00000000004014F4 ;   __try { // __except at loc_40150C
text:00000000004014F4                 mov     rax, cs:off_405850
text:00000000004014FB                 mov     dword ptr [rax], 0
text:0000000000401501                 call    sub_401650
text:0000000000401506                 call    sub_401180
text:000000000040150B                 nop
text:000000000040150B ;   } // starts at 4014F4
```

![https://academy.hackthebox.com/storage/modules/227/ida_text_view.png](https://academy.hackthebox.com/storage/modules/227/ida_text_view.png)

![https://academy.hackthebox.com/storage/modules/227/ida_text_view_arrows.png](https://academy.hackthebox.com/storage/modules/227/ida_text_view_arrows.png)

### Recognizing the Main Function in IDA

![https://academy.hackthebox.com/storage/modules/227/ida__001_start.png](https://academy.hackthebox.com/storage/modules/227/ida__001_start.png)

``` ida
public start
start proc near

; FUNCTION CHUNK AT .text:00000000004022A0 SIZE 000001B0 BYTES

; __unwind { // __C_specific_handler
sub     rsp, 28h
```

``` ida
loc_4014F4:
;   __try { // __except at loc_40150C
mov     rax, cs:off_405850
mov     dword ptr [rax], 0
call    sub_401650         ; Will inspect this function
call    sub_401180         ; Will inspect this function
nop
;   } // starts at 4014F4

-----------------------------------------------

loc_40150C:
;   __except(TopLevelExceptionFilter) // owned by 4014F4
nop
add     rsp, 28h
retn
; } // starts at 4014F0
start endp
```

### Navigating Through Functions in IDA

![https://academy.hackthebox.com/storage/modules/227/ida_function_calls.png](https://academy.hackthebox.com/storage/modules/227/ida_function_calls.png)

![https://academy.hackthebox.com/storage/modules/227/ida_function_enter.png](https://academy.hackthebox.com/storage/modules/227/ida_function_enter.png)

![https://academy.hackthebox.com/storage/modules/227/ida__002_initial_stack.png](https://academy.hackthebox.com/storage/modules/227/ida__002_initial_stack.png)

![https://academy.hackthebox.com/storage/modules/227/ida_go_back.png](https://academy.hackthebox.com/storage/modules/227/ida_go_back.png)

![https://academy.hackthebox.com/storage/modules/227/ida_go_back_enter.png](https://academy.hackthebox.com/storage/modules/227/ida_go_back_enter.png)

![https://academy.hackthebox.com/storage/modules/227/ida__003_startupinfo.png](https://academy.hackthebox.com/storage/modules/227/ida__003_startupinfo.png)

![https://academy.hackthebox.com/storage/modules/227/ida_004_intmain.png](https://academy.hackthebox.com/storage/modules/227/ida_004_intmain.png)

``` ida
call    sub_403250
```

![https://academy.hackthebox.com/storage/modules/227/ida_005_main.png](https://academy.hackthebox.com/storage/modules/227/ida_005_main.png)

``` ida
xor     r8d, r8d        ; ulOptions
mov     [rsp+148h+cbData], 100h
mov     [rsp+148h+phkResult], rax ; phkResult
mov     r9d, 20019h     ; samDesired
lea     rdx, aSoftwareVmware ; "SOFTWARE\\VMware, Inc.\\VMware Tools"
mov     rcx, 0FFFFFFFF80000002h ; hKey
call    cs:RegOpenKeyExA
```

![https://academy.hackthebox.com/storage/modules/227/ida_winapi.png](https://academy.hackthebox.com/storage/modules/227/ida_winapi.png)

``` ida
.idata:0000000000409370 ; LSTATUS (__stdcall *RegOpenKeyExA)(HKEY hKey, LPCSTR lpSubKey, DWORD ulOptions, REGSAM samDesired, PHKEY phkResult)
.idata:0000000000409370                 extrn RegOpenKeyExA:qword
.idata:0000000000409370                                         ; CODE XREF: sub_403160+3E↑p
.idata:0000000000409370                                         ; sub_403220+3C↑p
.idata:0000000000409370                                         ; DATA XREF: ...
```

![https://academy.hackthebox.com/storage/modules/227/ida_006_assumed_main.png](https://academy.hackthebox.com/storage/modules/227/ida_006_assumed_main.png)

![https://academy.hackthebox.com/storage/modules/227/ida_enter_init_checks_.png](https://academy.hackthebox.com/storage/modules/227/ida_enter_init_checks_.png)

![https://academy.hackthebox.com/storage/modules/227/ida_007_init_checks.png](https://academy.hackthebox.com/storage/modules/227/ida_007_init_checks.png)

``` ida
sub_401610 proc near

mov     eax, cs:dword_408030
test    eax, eax
jz      short loc_401620 

loc_401620:
mov     cs:dword_408030, 1
jmp     sub_4015A0
sub_401610 endp
```

``` ida
sub_4015A0 proc near

push    rsi
push    rbx
sub     rsp, 28h
mov     rdx, cs:off_405730
mov     rax, [rdx]
mov     ecx, eax
cmp     eax, 0FFFFFFFFh
jz      short loc_4015F0
```

![https://academy.hackthebox.com/storage/modules/227/correction.png](https://academy.hackthebox.com/storage/modules/227/correction.png)

![https://academy.hackthebox.com/storage/modules/227/ida_008_shellexecutea.png](https://academy.hackthebox.com/storage/modules/227/ida_008_shellexecutea.png)

``` ida
LSTATUS RegOpenKeyExA(
  [in]           HKEY   hKey,
  [in, optional] LPCSTR lpSubKey,
  [in]           DWORD  ulOptions,
  [in]           REGSAM samDesired,
  [out]          PHKEY  phkResult
);
```

![https://academy.hackthebox.com/storage/modules/227/msdn_001_regopenkey.png](https://academy.hackthebox.com/storage/modules/227/msdn_001_regopenkey.png)

``` ida
lea     rax, [rsp+148h+hKey]      ; Calculate the address of hKey
xor     r8d, r8d                  ; Clear r8d register (ulOptions)
mov     [rsp+148h+phkResult], rax ; Store the calculated address of hKey in phkResult
mov     r9d, 20019h               ; Set samDesired to 0x20019h (which is KEY_READ in MS-DOCS)
lea     rdx, aSoftwareVmware      ; Load address of string "SOFTWARE\\VMware, Inc.\\VMware Tools"
mov     rcx, 0FFFFFFFF80000002h   ; Set hKey to 0xFFFFFFFF80000002h (HKEY_LOCAL_MACHINE)
call    cs:RegOpenKeyExA          ; Call the RegOpenKeyExA function
test    eax, eax                  ; Check the return value
jnz     short loc_40330F          ; Jump if the return value is not zero (error condition)
```

![https://academy.hackthebox.com/storage/modules/227/ida_009_after_sandbox.png](https://academy.hackthebox.com/storage/modules/227/ida_009_after_sandbox.png)

![https://academy.hackthebox.com/storage/modules/227/ida_010_getaddrinfo.png](https://academy.hackthebox.com/storage/modules/227/ida_010_getaddrinfo.png)

![https://academy.hackthebox.com/storage/modules/227/ida_011_func_check.png](https://academy.hackthebox.com/storage/modules/227/ida_011_func_check.png)

![https://academy.hackthebox.com/storage/modules/227/ida_012_socketconnect.png](https://academy.hackthebox.com/storage/modules/227/ida_012_socketconnect.png)

![https://academy.hackthebox.com/storage/modules/227/ida_013_socketerror.png](https://academy.hackthebox.com/storage/modules/227/ida_013_socketerror.png)

``` ida
call    cs:connect
inc     eax
jnz     short loc_402CD0
```

![https://academy.hackthebox.com/storage/modules/227/ida_014_jump_check.png](https://academy.hackthebox.com/storage/modules/227/ida_014_jump_check.png)

![https://academy.hackthebox.com/storage/modules/227/ida_015_svchost.png](https://academy.hackthebox.com/storage/modules/227/ida_015_svchost.png)

``` ida
lea     rcx, VarName    ; "TEMP"
call    getenv
```

``` powershell-session
PS C:\> Get-ChildItem env:TEMP

Name                           Value
----                           -----
TEMP                           C:\Users\htb-student\AppData\Local\Temp
```

![https://academy.hackthebox.com/storage/modules/227/ida_016_svchost_download.png](https://academy.hackthebox.com/storage/modules/227/ida_016_svchost_download.png)

![https://academy.hackthebox.com/storage/modules/227/ida_016_svchost_temp.png](https://academy.hackthebox.com/storage/modules/227/ida_016_svchost_temp.png)

![https://academy.hackthebox.com/storage/modules/227/ida_017_createfile.png](https://academy.hackthebox.com/storage/modules/227/ida_017_createfile.png)

![https://academy.hackthebox.com/storage/modules/227/ida_018_readfile.png](https://academy.hackthebox.com/storage/modules/227/ida_018_readfile.png)

![https://academy.hackthebox.com/storage/modules/227/ida_018_writefile.png](https://academy.hackthebox.com/storage/modules/227/ida_018_writefile.png)

![https://academy.hackthebox.com/storage/modules/227/ida_19_reg.png](https://academy.hackthebox.com/storage/modules/227/ida_19_reg.png)

![https://academy.hackthebox.com/storage/modules/227/ida_020_regvalue.png](https://academy.hackthebox.com/storage/modules/227/ida_020_regvalue.png)

![https://academy.hackthebox.com/storage/modules/227/ida_021_pendingfunction.png](https://academy.hackthebox.com/storage/modules/227/ida_021_pendingfunction.png)

![https://academy.hackthebox.com/storage/modules/227/ida_022_notepad.png](https://academy.hackthebox.com/storage/modules/227/ida_022_notepad.png)

``` ida
BOOL CreateProcessA(
  [in, optional]      LPCSTR                lpApplicationName,
  [in, out, optional] LPSTR                 lpCommandLine,
  [in, optional]      LPSECURITY_ATTRIBUTES lpProcessAttributes,
  [in, optional]      LPSECURITY_ATTRIBUTES lpThreadAttributes,
  [in]                BOOL                  bInheritHandles,
  [in]                DWORD                 dwCreationFlags,
  [in, optional]      LPVOID                lpEnvironment,
  [in, optional]      LPCSTR                lpCurrentDirectory,
  [in]                LPSTARTUPINFOA        lpStartupInfo,
  [out]               LPPROCESS_INFORMATION lpProcessInformation
);
```

![https://academy.hackthebox.com/storage/modules/227/ida_createProcess.png](https://academy.hackthebox.com/storage/modules/227/ida_createProcess.png)

![https://academy.hackthebox.com/storage/modules/227/ida_023_procInj.png](https://academy.hackthebox.com/storage/modules/227/ida_023_procInj.png)

![https://academy.hackthebox.com/storage/modules/227/ida_023_conn_sent.png](https://academy.hackthebox.com/storage/modules/227/ida_023_conn_sent.png)

![https://academy.hackthebox.com/storage/modules/227/ida_024_shellcode.png](https://academy.hackthebox.com/storage/modules/227/ida_024_shellcode.png)

![https://academy.hackthebox.com/storage/modules/227/ida_025_backtomain.png](https://academy.hackthebox.com/storage/modules/227/ida_025_backtomain.png)

![https://academy.hackthebox.com/storage/modules/227/ida_graph_flow.png](https://academy.hackthebox.com/storage/modules/227/ida_graph_flow.png)

![https://academy.hackthebox.com/storage/modules/227/ida_026_callflowgraph.png](https://academy.hackthebox.com/storage/modules/227/ida_026_callflowgraph.png)

# 

# 

#### Questions

####